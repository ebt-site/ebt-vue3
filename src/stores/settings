import { defineStore } from 'pinia'
import { logger } from 'log-instance'
import Utils from "../utils.mjs";
import { default as Settings } from "../../src/ebt-settings.mjs";
import { default as EbtCard } from "../../src/ebt-card.mjs";

var id = 1;

export const useSettingsStore = defineStore('settings', {
  state: () => {
    let s = Object.assign({}, Settings.INITIAL_STATE);
    s.id = id++;
    let savedState = localStorage.settings;
    if (savedState) {
      try {
        savedState = JSON.parse(savedState);
        let { cards } = savedState;
        if (cards == null) {
          cards = savedState.cards = [{}];
        }
        cards.forEach((card,i) => {
          cards[i] = new EbtCard(card);
        });
      } catch(e) {
        logger.error(`SettingsStore.state() corrupt localStorage`, 
          savedState, e.message);
        savedState = null;
      }
    }
    if (savedState) {
      Utils.assignTyped(s, savedState, Settings.INITIAL_STATE);
      s.cards = savedState.cards;
    }
    logger.debug(`SettingsStore.state() => `, s);
    return s;
  },
  actions: {
    saveSettings() {
      let saved = Utils.assignTyped({}, this, Settings.INITIAL_STATE);
      saved.cards = this.cards;
      let json = JSON.stringify(saved);
      localStorage.settings = json;
      logger.debug('saveSettings', json);
      logger.info("SettingsStore.saveSettings() localStorage.settings", 
        localStorage.settings);
    },
    removeCard(card) {
      this.cards = this.cards.filter(c => c !== card);
    },
    addCard(opts) {
      this.cards.push(new EbtCard(opts));
    },
    pathToCard(path) {
      let { cards } = this;
      let [ tbd, context, ...location ]  = path.split('/');
      let card = cards.find(card => card.matchPath(path));
      if (card == null) {
        card = this.addCard({context, location});
        console.log(`pathToCard ${path} (NEW)`, card);
      } else {
        console.log(`pathToCard ${path} (EXISTING))`, card);
      } 

      return card;
    },
    clear() {
      delete localStorage.settings;
      Utils.assignTyped(this, Settings.INITIAL_STATE);
      logger.debug(`SettingsStore.clear()`, this);
    },
  },
  getters: {
    servers: (state)=>{ 
      let isDev = window.location.host.startsWith('localhost');;
      let servers = Settings.SERVERS.filter(svr => !svr.dev || isDev);
      return servers;
    },
    server: (state)=>{
      return state.servers.reduce((a,v) => {
        return v.value === state.serverUrl ? v : a;
      }, "unknown");
    },
  },

})
